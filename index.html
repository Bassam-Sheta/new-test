<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Full Quiz Application</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #FFFFFF;
      color: #000000;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 20px auto;
    }
    .start-dialog, .quiz, .result {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 6px;
      background-color: #f9f9f9;
    }
    .start-dialog input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .btn {
      background-color: #4CAF50;
      color: #FFFFFF;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .question {
      margin-bottom: 20px;
    }
    .explanation {
      font-size: 16px;
      margin: 10px 0;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .canvas-container {
      display: flex;
      justify-content: space-around;
      margin: 10px 0;
    }
    canvas {
      border: 1px solid #000;
    }
    .checkbox-group,
    .ordering-group {
      margin: 10px 0;
    }
    .ordering-group {
      border: 1px solid #aaa;
      padding: 10px;
      border-radius: 4px;
      background-color: #fff;
      min-height: 100px;
      margin-top: 10px;
    }
    .ordering-item {
      padding: 8px;
      margin: 4px 0;
      background: #eee;
      cursor: move;
      border: 1px solid #ccc;
    }
    .drag-over {
      border: 2px dashed #000;
    }
    /* Add a dragging class for visual feedback */
    .dragging {
      opacity: 0.5;
    }
    .timer {
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Start Dialog -->
    <div id="startDialog" class="start-dialog">
      <h2>Welcome to the Test</h2>
      <p>
        Please note: The quiz has three parts. Q3 (Barista Tasks Ordering) will be shown first, followed by Q1 (Global Client Audit) and then Q2 (Football Tournament Data).
      </p>
      <input type="text" id="usernameInput" placeholder="Enter your name" />
      <button id="startBtn" class="btn">Submit</button>
    </div>

    <!-- Quiz Section -->
    <div id="quizSection" class="quiz" style="display: none;">
      <div class="timer" id="timerDisplay">Time: 0</div>
      <div id="questionContainer"></div>
      <div style="margin-top: 20px;">
        <button id="submitBtn" class="btn">Submit</button>
        <button id="skipBtn" class="btn">Skip</button>
      </div>
    </div>

    <!-- Result Section -->
    <div id="resultSection" class="result" style="display: none;">
      <h2>Quiz Completed!</h2>
      <p id="resultMessage"></p>
    </div>
  </div>

  <script>
    /***********************
     * 1. Quiz Data & State
     ***********************/
    let username = '';
    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval = null;
    let remainingTime = 0;
    const quizStartTime = new Date();
    const logEntries = []; // Full log for all questions

    // Define questions with Q3 first, then Q1, then Q2.
    const questions = (function() {
      // Q3: Barista Tasks Ordering
      const explanationQ3 = "You’re covering for a barista who left a voicemail:\n\n" +
        "“Hey! Thanks for helping out. First, check today’s delivery slip—it’s in the top drawer (code: 1122). " +
        "After restocking cups, check the whiteboard for custom orders. If there’s a ‘machine maintenance’ alert, " +
        "prioritize it over custom orders. Once done, lock the cash register, refill the sugar jars, and text me a summary. " +
        "Oh, and refill the sugar jars after locking up! Don’t forget!”\n\n" +
        "Place the tasks in the correct order:";

      const stepsQ3 = [
        "Unlock drawer (code: 1122)",
        "Check delivery slip",
        "Restock cups",
        "Review whiteboard orders",
        "Fix machine alerts (if any)",
        "Handle custom orders",
        "Lock cash register",
        "Refill sugar jars",
        "Send summary text"
      ];
      const q3 = {
        question: "Barista Tasks Ordering",
        explanation: explanationQ3,
        type: "ordering",
        time: 270,
        steps: stepsQ3
      };

      // Q1: Global Client Audit (Y/N Sub-Questions)
      const q1 = {
        question: "Global Client Audit",
        instructions: "Mark Y (Match) or N (Mismatch) for each sub-item.",
        type: "y_n_subq",
        time: 120,
        sub_questions: [
          { item: "Client Name", paper: "Dr. Emília Rodríguez-Sánchez", screen: "Dr. Emilía Rodriguez-Sanchez", correct: "N" },
          { item: "Account ID", paper: "#AC-2023-0I9B4Q", screen: "#AC-2023-0I9B4Q", correct: "Y" },
          { item: "Invoice Date", paper: "10.04.2024", screen: "10/04/2024", correct: "N" },
          { item: "Email", paper: "support@corpα.com (Greek α)", screen: "support@corpα.com", correct: "Y" },
          { item: "SWIFT Code", paper: "DEUTDEDB380", screen: "DEUTDEDB3B0", correct: "N" },
          { item: "Address", paper: "45 Rue de la Paix, 7500₂, Paris", screen: "45 Rue de la Paix, 7500₂, Paris", correct: "Y" },
          { item: "Contract Value", paper: "¥12,345,678.90", screen: "¥12.345.678,90", correct: "N" },
          { item: "Payment Ref", paper: "TXN-ID: 8S2G7HJKᴮᴺ", screen: "TXN-ID: 8S2G7HJKᴮᴺ", correct: "Y" },
          { item: "Tax Code", paper: "IT-001234567-9", screen: "IT-0012345b7-9", correct: "N" },
          { item: "IBAN", paper: "GB29NWBK60161331926819", screen: "GB29NWBK60161331926819", correct: "Y" },
          { item: "Phone", paper: "+33 1 70 22 18 76", screen: "+33 1 70 22 81 76", correct: "N" },
          { item: "Delivery Code", paper: "DPD#XQ-ΓΤΨ-2024", screen: "DPD#XQ-ΓΤΦ-2024", correct: "N" }
        ]
      };

      // Q2: Football Tournament Data (Canvas + Checkboxes)
      const report1 = [
        ["Player#", "Goals", "KeyPass", "MotM?", "Bonus"],
        ["7", "2", "15", "yes", "A-2.5"],
        ["10", "5", "22", "no", "B-3"],
        ["12", "9", "28", "yes", "C-7"],
        ["15", "4", "20", "no", "D-2"],
        ["18", "7", "31", "yes", "E-5"],
        ["21", "10", "25", "no", "F-3"],
        ["24", "12", "20", "yes", "G-4"]
      ];
      const report2 = [
        ["Player#", "MotM?", "Bonus", "Goals", "KeyPass"],
        ["7", "yes", "A-2.5", "2", "15"],
        ["10", "no", "B-3", "6", "22"],
        ["12", "yes", "C-7", "8", "28"],
        ["15", "no", "D-2", "4", "20"],
        ["18", "yes", "E-5", "7", "31"],
        ["21", "no", "F-3", "10", "25"],
        ["24", "yes", "G-4,0", "12", "20"]
      ];
      const q2 = {
        question: "Football Tournament Data",
        instructions: "Below are two reports showing performance data for 7 players. Select the players with inconsistent data.",
        type: "checkbox_image",
        time: 240,
        options: ["7", "10", "12", "15", "18", "21", "24"],
        // For Q2, only 4 of the 7 options are correct.
        correct_indices: [1, 2, 4, 6],
        reports: { report1, report2 }
      };

      return [q3, q1, q2];
    })();

    /***********************
     * 2. Utility & Timer Functions
     ***********************/
    function startTimer(duration, display, onTimeUp) {
      remainingTime = duration;
      display.textContent = "Time: " + remainingTime;
      timerInterval = setInterval(function() {
        remainingTime--;
        display.textContent = "Time: " + remainingTime;
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          onTimeUp();
        }
      }, 1000);
    }

    /***********************
     * 3. Main Quiz Flow
     ***********************/
    function loadQuestion() {
      clearInterval(timerInterval);
      const questionContainer = document.getElementById("questionContainer");
      questionContainer.innerHTML = "";

      if (currentQuestionIndex >= questions.length) {
        endQuiz();
        return;
      }

      const qdata = questions[currentQuestionIndex];
      document.getElementById("timerDisplay").textContent = "Time: " + qdata.time;

      // Build question UI container
      const qElem = document.createElement("div");
      qElem.className = "question";

      // Question Title
      const qTitle = document.createElement("h3");
      qTitle.innerText = qdata.question;
      qElem.appendChild(qTitle);

      // Explanation paragraph (if provided)
      if (qdata.explanation) {
        const expl = document.createElement("p");
        expl.className = "explanation";
        expl.innerText = qdata.explanation;
        qElem.appendChild(expl);
      }

      // Instructions (if provided)
      if (qdata.instructions) {
        const instr = document.createElement("p");
        instr.className = "explanation";
        instr.innerText = qdata.instructions;
        qElem.appendChild(instr);
      }

      // Render based on question type
      if (qdata.type === "ordering") {
        // Ordering question UI (only for Q3)
        const orderingHeading = document.createElement("h4");
        orderingHeading.innerText = "Drag and drop the tasks in the correct order:";
        qElem.appendChild(orderingHeading);

        const listContainer = document.createElement("div");
        listContainer.className = "ordering-group";
        const list = document.createElement("ul");
        list.id = "orderingList";
        list.style.listStyleType = "none";

        // Shuffle steps for a random initial order
        const shuffled = qdata.steps.slice().sort(() => Math.random() - 0.5);
        shuffled.forEach(step => {
          const li = document.createElement("li");
          li.innerText = step;
          li.className = "ordering-item";
          li.setAttribute("draggable", "true");
          list.appendChild(li);
        });

        listContainer.appendChild(list);
        qElem.appendChild(listContainer);

        // Only call addDragAndDropHandlers() when type is ordering
        addDragAndDropHandlers();
      }
      else if (qdata.type === "y_n_subq") {
        // Render Y/N sub-questions for Q1
        qdata.sub_questions.forEach((subq, idx) => {
          const subDiv = document.createElement("div");
          subDiv.className = "sub-question";
          const label = document.createElement("label");
          label.innerText = `${subq.item} | Paper: ${subq.paper} | Screen: ${subq.screen}`;
          subDiv.appendChild(label);
          subDiv.appendChild(document.createElement("br"));
          // Y radio
          const radioY = document.createElement("input");
          radioY.type = "radio";
          radioY.name = "subq" + idx;
          radioY.value = "Y";
          const labelY = document.createElement("label");
          labelY.innerText = " Y ";
          // N radio
          const radioN = document.createElement("input");
          radioN.type = "radio";
          radioN.name = "subq" + idx;
          radioN.value = "N";
          const labelN = document.createElement("label");
          labelN.innerText = " N ";
          subDiv.appendChild(radioY);
          subDiv.appendChild(labelY);
          subDiv.appendChild(radioN);
          subDiv.appendChild(labelN);
          qElem.appendChild(subDiv);
        });
      }
      else if (qdata.type === "checkbox_image") {
        // Render canvases for Q2
        const canvasContainer = document.createElement("div");
        canvasContainer.className = "canvas-container";
        const canvas1 = document.createElement("canvas");
        canvas1.id = "canvas1";
        canvas1.width = 400;
        canvas1.height = 200;
        const canvas2 = document.createElement("canvas");
        canvas2.id = "canvas2";
        canvas2.width = 400;
        canvas2.height = 200;
        canvasContainer.appendChild(canvas1);
        canvasContainer.appendChild(canvas2);
        qElem.appendChild(canvasContainer);

        // Render checkboxes for Q2
        const cbGroup = document.createElement("div");
        cbGroup.className = "checkbox-group";
        qdata.options.forEach((option, idx) => {
          const cbLabel = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = idx;
          cbLabel.appendChild(checkbox);
          cbLabel.appendChild(document.createTextNode(" " + option));
          cbGroup.appendChild(cbLabel);
          cbGroup.appendChild(document.createElement("br"));
        });
        qElem.appendChild(cbGroup);

        // Draw canvases after a short delay to ensure rendering
        setTimeout(() => {
          drawTable("canvas1", qdata.reports.report1);
          drawTable("canvas2", qdata.reports.report2);
        }, 300);
      }

      questionContainer.appendChild(qElem);
      startTimer(qdata.time, document.getElementById("timerDisplay"), () => submitAnswer(true));
    }

    /***********************
     * 4. Drag-and-Drop Handlers (Only for ordering questions)
     ***********************/
    function addDragAndDropHandlers() {
      const list = document.getElementById("orderingList");
      if (!list) return;  // Only proceed if the element exists
      const items = list.querySelectorAll(".ordering-item");
      items.forEach(item => {
        item.setAttribute("draggable", "true");
        item.addEventListener("dragstart", dragStart, false);
        item.addEventListener("dragover", dragOver, false);
        item.addEventListener("dragenter", dragEnter, false);
        item.addEventListener("dragleave", dragLeave, false);
        item.addEventListener("drop", dragDrop, false);
        item.addEventListener("dragend", dragEnd, false);
      });
    }

    function dragStart(e) {
      this.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", this.innerText);
      // Optionally, set a custom drag image
      if (e.dataTransfer.setDragImage) {
        e.dataTransfer.setDragImage(this, 10, 10);
      }
    }

    function dragOver(e) {
      e.preventDefault(); // Necessary. Allows us to drop.
      e.dataTransfer.dropEffect = "move";
      return false;
    }

    function dragEnter(e) {
      this.classList.add("drag-over");
    }

    function dragLeave(e) {
      this.classList.remove("drag-over");
    }

    function dragDrop(e) {
      e.stopPropagation();
      // Swap innerText of the dragged item and the drop target
      const dragged = document.querySelector(".dragging");
      if (dragged && dragged !== this) {
        const temp = dragged.innerText;
        dragged.innerText = this.innerText;
        this.innerText = temp;
      }
      return false;
    }

    function dragEnd(e) {
      this.classList.remove("dragging");
      const items = document.querySelectorAll(".ordering-item");
      items.forEach(item => item.classList.remove("drag-over"));
    }

    /***********************
     * 5. Canvas Drawing Function (for Q2)
     ***********************/
    function drawTable(canvasId, data) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const cellW = 80, cellH = 25;
      ctx.fillStyle = "#FFFFFF";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.font = "10px Arial";
      ctx.strokeStyle = "#000000";
      for (let i = 0; i < data.length; i++) {
        for (let j = 0; j < data[i].length; j++) {
          const x = j * cellW, y = i * cellH;
          ctx.strokeRect(x, y, cellW, cellH);
          ctx.fillStyle = "#000000";
          ctx.fillText(data[i][j], x + 3, y + 17);
        }
      }
    }

    /***********************
     * 6. Submission and Quiz End Functions
     ***********************/
    function submitAnswer(auto = false) {
      clearInterval(timerInterval);
      const qdata = questions[currentQuestionIndex];
      let subScore = 0;
      let totalSub = 0;
      let logText = `User: ${username} | Q: ${qdata.question}\n`;

      if (qdata.type === "ordering") {
        const listItems = document.querySelectorAll("#orderingList li");
        totalSub = listItems.length;
        const userOrder = [];
        listItems.forEach(li => userOrder.push(li.innerText));
        logText += "User's order:\n";
        userOrder.forEach((step, i) => { logText += (i + 1) + ". " + step + "\n"; });
        qdata.steps.forEach((correctStep, idx) => {
          if (userOrder[idx] === correctStep) subScore++;
        });
        logText += `Score: ${subScore} / ${totalSub}\n`;
      }
      else if (qdata.type === "y_n_subq") {
        qdata.sub_questions.forEach((subq, idx) => {
          totalSub++;
          const radios = document.getElementsByName("subq" + idx);
          let answer = null;
          radios.forEach(r => { if (r.checked) answer = r.value; });
          logText += `${subq.item} => user: ${answer || "No answer"}, correct: ${subq.correct}\n`;
          if (answer === subq.correct) subScore++;
        });
        logText += `Score: ${subScore} / ${totalSub}\n`;
      }
      else if (qdata.type === "checkbox_image") {
        // For Q2, we want a maximum score of 4.
        totalSub = qdata.correct_indices.length;
        const checkboxes = document.querySelectorAll(".checkbox-group input[type='checkbox']");
        const userIndices = [];
        checkboxes.forEach(cb => { if (cb.checked) userIndices.push(parseInt(cb.value)); });
        logText += `User selected: ${userIndices}\n`;
        logText += `Correct: ${qdata.correct_indices}\n`;
        if (arraysEqual(userIndices.sort(), qdata.correct_indices.slice().sort())) {
          subScore = totalSub;
        } else {
          subScore = 0;
        }
        logText += `Score: ${subScore} / ${totalSub}\n`;
      }

      score += subScore;
      logEntries.push(logText);
      currentQuestionIndex++;

      // Fade transition effect before loading next question or ending quiz
      const quizSection = document.getElementById("quizSection");
      quizSection.style.opacity = 1;
      let fadeOut = setInterval(() => {
        if (quizSection.style.opacity > 0) {
          quizSection.style.opacity -= 0.1;
        } else {
          clearInterval(fadeOut);
          loadQuestion();  // If no more questions, this triggers endQuiz()
          let fadeIn = setInterval(() => {
            if (quizSection.style.opacity < 1) {
              quizSection.style.opacity = parseFloat(quizSection.style.opacity) + 0.1;
            } else {
              clearInterval(fadeIn);
            }
          }, 50);
        }
      }, 50);
    }

    function skipQuestion() {
      clearInterval(timerInterval);
      currentQuestionIndex++;
      loadQuestion();
    }

    /***********************
     * 7. End Quiz
     ***********************/
    function endQuiz() {
      clearInterval(timerInterval);
      document.getElementById("quizSection").style.display = "none";
      const resultSection = document.getElementById("resultSection");
      const totalPossible = questions.reduce((acc, q) => {
        if (q.type === "ordering") return acc + q.steps.length;
        if (q.type === "y_n_subq") return acc + q.sub_questions.length;
        if (q.type === "checkbox_image") return acc + q.correct_indices.length;
        return acc;
      }, 0);
      const finishTime = new Date();
      const finalScoreText = `Total Score: ${score} / ${totalPossible}`;
      document.getElementById("resultMessage").innerText = finalScoreText;
      resultSection.style.display = "block";
      console.log("Quiz Completed! " + finalScoreText);
      // Optionally: send log data to Google Sheets here.
    }

    /***********************
     * 8. Helper: Array Equality
     ***********************/
    function arraysEqual(a, b) {
      return a.length === b.length && a.every((v, i) => v === b[i]);
    }

    /***********************
     * 9. Event Listeners
     ***********************/
    document.getElementById("startBtn").addEventListener("click", () => {
      const input = document.getElementById("usernameInput").value.trim();
      if (!input) {
        alert("Please enter your name.");
        return;
      }
      username = input;
      document.getElementById("startDialog").style.display = "none";
      document.getElementById("quizSection").style.display = "block";
      loadQuestion();
    });
    document.getElementById("submitBtn").addEventListener("click", () => submitAnswer(false));
    document.getElementById("skipBtn").addEventListener("click", () => skipQuestion());
  </script>
</body>
</html>
