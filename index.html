<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Q3-Only Styled Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #FFFFFF;
      color: #000000;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 20px auto;
    }
    .start-dialog, .quiz, .result {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 6px;
      background-color: #f9f9f9;
    }
    .start-dialog input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .btn {
      background-color: #4CAF50;
      color: #FFFFFF;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .question {
      margin-bottom: 20px;
    }
    .ordering-group {
      border: 1px solid #aaa;
      padding: 10px;
      border-radius: 4px;
      background-color: #fff;
      min-height: 100px;
      margin-top: 10px;
    }
    .ordering-item {
      padding: 8px;
      margin: 4px 0;
      background: #eee;
      cursor: move;
      border: 1px solid #ccc;
    }
    .drag-over {
      border: 2px dashed #000;
    }
    .timer {
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Start Dialog -->
    <div id="startDialog" class="start-dialog">
      <h2>Welcome to the Test</h2>
      <p>This version has only the barista tasks ordering question (Q3).</p>
      <input type="text" id="usernameInput" placeholder="Enter your name" />
      <button id="startBtn" class="btn">Submit</button>
    </div>
    
    <!-- Quiz Section -->
    <div id="quizSection" class="quiz" style="display: none;">
      <div class="timer" id="timerDisplay">Time: 0</div>
      <div id="questionContainer"></div>
      <div style="margin-top: 20px;">
        <button id="submitBtn" class="btn">Submit</button>
        <button id="skipBtn" class="btn">Skip</button>
      </div>
    </div>
    
    <!-- Result Section -->
    <div id="resultSection" class="result" style="display: none;">
      <h2>Quiz Completed!</h2>
      <p id="resultMessage"></p>
    </div>
  </div>
  
  <script>
    // ---------------------------
    // 1. Quiz Data & State
    // ---------------------------
    let username = '';
    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval = null;
    let remainingTime = 0;
    const quizStartTime = new Date();
    const logEntries = [];

    // Q3 (Barista Tasks) as a single question in an array
    const questions = (function() {
      // The barista tasks ordering question
      const steps = [
        "Unlock drawer (code: 1122)",
        "Check delivery slip",
        "Restock cups",
        "Review whiteboard orders",
        "Fix machine alerts (if any)",
        "Handle custom orders",
        "Lock cash register",
        "Refill sugar jars",
        "Send summary text"
      ];
      const q3 = {
        question: "Barista Tasks Ordering (Single-Question Demo)",
        type: "ordering",
        time: 270,  // 4.5 minutes
        steps: steps
      };
      // Return just Q3 in the array
      return [q3];
    })();

    // ---------------------------
    // 2. Utility & Timer
    // ---------------------------
    function startTimer(duration, display, onTimeUp) {
      remainingTime = duration;
      display.textContent = "Time: " + remainingTime;
      timerInterval = setInterval(function() {
        remainingTime--;
        display.textContent = "Time: " + remainingTime;
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          onTimeUp();
        }
      }, 1000);
    }

    // ---------------------------
    // 3. Main Quiz Flow
    // ---------------------------
    function loadQuestion() {
      clearInterval(timerInterval);
      const questionContainer = document.getElementById("questionContainer");
      questionContainer.innerHTML = "";

      // If we've passed the only question, end
      if (currentQuestionIndex >= questions.length) {
        endQuiz();
        return;
      }

      const qdata = questions[currentQuestionIndex];
      document.getElementById("timerDisplay").textContent = "Time: " + qdata.time;

      // Build question UI
      const qElem = document.createElement("div");
      qElem.className = "question";
      const qTitle = document.createElement("h3");
      qTitle.innerText = qdata.question;
      qElem.appendChild(qTitle);

      // Because it's the only question, we know it's ordering
      const orderingHeading = document.createElement("h4");
      orderingHeading.innerText = "Drag and drop the tasks in the correct order:";
      qElem.appendChild(orderingHeading);

      const listContainer = document.createElement("div");
      listContainer.className = "ordering-group";

      const list = document.createElement("ul");
      list.id = "orderingList";
      list.style.listStyleType = "none";

      // Shuffle steps for random initial order
      const shuffled = qdata.steps.slice().sort(() => Math.random() - 0.5);
      shuffled.forEach(step => {
        const li = document.createElement("li");
        li.innerText = step;
        li.className = "ordering-item";
        li.draggable = true;
        list.appendChild(li);
      });

      listContainer.appendChild(list);
      qElem.appendChild(listContainer);
      questionContainer.appendChild(qElem);

      // Add drag/drop logic
      addDragAndDropHandlers();

      // Start the timer
      startTimer(qdata.time, document.getElementById("timerDisplay"), () => submitAnswer(true));
    }

    // ---------------------------
    // 4. Drag-and-Drop
    // ---------------------------
    function addDragAndDropHandlers() {
      const list = document.getElementById("orderingList");
      let dragSrcEl = null;

      function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/html", this.innerHTML);
      }
      function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        return false;
      }
      function handleDragEnter(e) {
        this.classList.add("drag-over");
      }
      function handleDragLeave(e) {
        this.classList.remove("drag-over");
      }
      function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrcEl !== this) {
          dragSrcEl.innerHTML = this.innerHTML;
          this.innerHTML = e.dataTransfer.getData("text/html");
        }
        return false;
      }
      function handleDragEnd(e) {
        this.classList.remove("drag-over");
        const items = list.querySelectorAll(".ordering-item");
        items.forEach(item => item.classList.remove("drag-over"));
      }

      const items = list.querySelectorAll(".ordering-item");
      items.forEach(item => {
        item.addEventListener("dragstart", handleDragStart, false);
        item.addEventListener("dragenter", handleDragEnter, false);
        item.addEventListener("dragover", handleDragOver, false);
        item.addEventListener("dragleave", handleDragLeave, false);
        item.addEventListener("drop", handleDrop, false);
        item.addEventListener("dragend", handleDragEnd, false);
      });
    }

    // ---------------------------
    // 5. Submission and End
    // ---------------------------
    function submitAnswer(auto = false) {
      clearInterval(timerInterval);
      const qdata = questions[currentQuestionIndex];
      let subScore = 0;
      let totalSub = 0;
      let logText = "User: " + username + " | Q: " + qdata.question + "\n";

      // Only one question, type=ordering
      const listItems = document.querySelectorAll("#orderingList li");
      totalSub = listItems.length;
      const userOrder = [];
      listItems.forEach(li => userOrder.push(li.innerText));
      logText += "User's order:\n";
      userOrder.forEach((step, i) => {
        logText += (i + 1) + ". " + step + "\n";
      });

      // Compare with correct order
      qdata.steps.forEach((correctStep, idx) => {
        if (userOrder[idx] === correctStep) subScore++;
      });
      logText += "Score: " + subScore + " / " + totalSub + "\n";

      score += subScore;
      logEntries.push(logText);
      currentQuestionIndex++;

      // Fade out, then load next (but there's no next)
      const quizSection = document.getElementById("quizSection");
      quizSection.style.opacity = 1;
      let fadeOut = setInterval(() => {
        if (quizSection.style.opacity > 0) {
          quizSection.style.opacity -= 0.1;
        } else {
          clearInterval(fadeOut);
          loadQuestion(); // Will trigger endQuiz() since we only have 1 question
          let fadeIn = setInterval(() => {
            if (quizSection.style.opacity < 1) {
              quizSection.style.opacity = parseFloat(quizSection.style.opacity) + 0.1;
            } else {
              clearInterval(fadeIn);
            }
          }, 50);
        }
      }, 50);
    }

    function skipQuestion() {
      clearInterval(timerInterval);
      currentQuestionIndex++;
      loadQuestion();
    }

    function endQuiz() {
      clearInterval(timerInterval);
      document.getElementById("quizSection").style.display = "none";
      const resultSection = document.getElementById("resultSection");
      // Score logic
      const totalPossible = questions[0].steps.length;
      const finishTime = new Date();
      const details = "Start Time: " + quizStartTime.toLocaleString() + "\n" +
                      "End Time: " + finishTime.toLocaleString() + "\n" +
                      "Total Score: " + score + " / " + totalPossible + "\n" +
                      "Log Details:\n" + logEntries.join("\n");
      document.getElementById("resultMessage").innerText = details;
      resultSection.style.display = "block";
      console.log("Quiz Completed!\n" + details);
    }

    // ---------------------------
    // 6. Event Listeners
    // ---------------------------
    document.getElementById("startBtn").addEventListener("click", function() {
      const input = document.getElementById("usernameInput").value.trim();
      if (!input) {
        alert("Please enter your name.");
        return;
      }
      username = input;
      document.getElementById("startDialog").style.display = "none";
      document.getElementById("quizSection").style.display = "block";
      loadQuestion();
    });

    document.getElementById("submitBtn").addEventListener("click", function() {
      submitAnswer(false);
    });
    document.getElementById("skipBtn").addEventListener("click", function() {
      skipQuestion();
    });
  </script>
</body>
</html>
